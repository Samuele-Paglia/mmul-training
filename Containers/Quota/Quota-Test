###############################################################################
# Create a definition for the pod quota
###############################################################################
rasca@anomalia [~/MMUL/Avaloq]> cat pods.yml 
apiVersion: v1
kind: ResourceQuota
metadata:
  name: max-pod-number
spec:
  hard:
    pods: 5

###############################################################################
# In the project with no apps
###############################################################################
rasca@anomalia [~/MMUL/Avaloq]> oc projects
You have access to the following projects and can switch between them with 'oc project <projectname>':

    default
    kube-dns
    kube-proxy
    kube-public
    kube-system
    myproject - My Project
    openshift
    openshift-apiserver
    openshift-controller-manager
    openshift-core-operators
    openshift-infra
    openshift-node
    openshift-web-console
  * test-resources

Using project "test-resources" on server "https://192.168.42.251:8443".
rasca@anomalia [~/MMUL/Avaloq]> oc status
In project test-resources on server https://192.168.42.251:8443

You have no services, deployment configs, or build configs.
Run 'oc new-app' to create an application.

###############################################################################
# Create the resourcequota resource defined earlier
###############################################################################
rasca@anomalia [~/MMUL/Avaloq]> oc create -f pods.yml 
resourcequota "max-pod-number" created

rasca@anomalia [~/MMUL/Avaloq]> oc get resourcequota
NAME             AGE
max-pod-number   8s

rasca@anomalia [~/MMUL/Avaloq]> oc describe resourcequota
Name:       max-pod-number
Namespace:  test-resources
Resource    Used  Hard
--------    ----  ----
pods        0     5

###############################################################################
# Set the policy anyuid for the project and the edit role for the developer
# user
###############################################################################
rasca@anomalia [~/MMUL/Avaloq]>  oc adm policy add-scc-to-user anyuid -n test-resources -z default
scc "anyuid" added to: ["system:serviceaccount:test-resources:default"]
rasca@anomalia [~/MMUL/Avaloq]> oc adm policy add-role-to-user edit developer
role "edit" added: "developer"

###############################################################################
# As developer create an app
###############################################################################
rasca@anomalia [~/MMUL/Avaloq]> oc login -u developer
Logged into "https://192.168.42.251:8443" as "developer" using existing credentials.

You have access to the following projects and can switch between them with 'oc project <projectname>':

    myproject
  * test-resources

Using project "test-resources".

rasca@anomalia [~/MMUL/Avaloq]> oc new-app --name=nginx-test --docker-image=nginx
--> Found Docker image 7042885 (6 days old) from Docker Hub for "nginx"

    * An image stream will be created as "nginx-test:latest" that will track this image
    * This image will be deployed in deployment config "nginx-test"
    * Port 80/tcp will be load balanced by service "nginx-test"
      * Other containers can access this service through the hostname "nginx-test"
    * WARNING: Image "nginx" runs as the 'root' user which may not be permitted by your cluster administrator

--> Creating resources ...
    imagestream "nginx-test" created
    deploymentconfig "nginx-test" created
    service "nginx-test" created
--> Success
    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:
     'oc expose svc/nginx-test' 
    Run 'oc status' to view your app.

###############################################################################
# Create a definition for the pod quota
###############################################################################
rasca@anomalia [~/MMUL/Avaloq]> oc get resourcequota
NAME             AGE
max-pod-number   3m
rasca@anomalia [~/MMUL/Avaloq]> oc describe resourcequota
Name:       max-pod-number
Namespace:  test-resources
Resource    Used  Hard
--------    ----  ----
pods        0     5

rasca@anomalia [~/MMUL/Avaloq]> oc status
In project test-resources on server https://192.168.42.251:8443

svc/nginx-test - 172.30.3.95:80
  dc/nginx-test deploys istag/nginx-test:latest 
    deployment #1 running for 6 seconds - 1 pod


3 infos identified, use 'oc status -v' to see details.

###############################################################################
# Scale the app to 5 and check the total number of pods
###############################################################################
rasca@anomalia [~/MMUL/Avaloq]> oc scale dc nginx-test --replicas=5
deploymentconfig.apps.openshift.io "nginx-test" scaled

rasca@anomalia [~/MMUL/Avaloq]> oc status
In project test-resources on server https://192.168.42.251:8443

svc/nginx-test - 172.30.3.95:80
  dc/nginx-test deploys istag/nginx-test:latest 
    deployment #1 deployed 31 seconds ago - 5 pods


2 infos identified, use 'oc status -v' to see details.

###############################################################################
# Scale the app to 6 and check the total number of pods
###############################################################################
rasca@anomalia [~/MMUL/Avaloq]> oc scale dc nginx-test --replicas=6
deploymentconfig.apps.openshift.io "nginx-test" scaled

rasca@anomalia [~/MMUL/Avaloq]> oc status
In project test-resources on server https://192.168.42.251:8443

svc/nginx-test - 172.30.3.95:80
  dc/nginx-test deploys istag/nginx-test:latest 
    deployment #1 deployed 2 minutes ago - 5/6 pods growing to 6


2 infos identified, use 'oc status -v' to see details.

rasca@anomalia [~/MMUL/Avaloq]> oc get events | grep exceeded
...
...
1m          1m           5         nginx-test-1.15769f97bf44353b          ReplicationController                                 Warning   FailedCreate                  replication-controller        (combined from similar events): Error creating: pods "nginx-test-1-2vrfd" is forbidden: exceeded quota: max-pod-number, requested: pods=1, used: pods=5, limited: pods=5

###############################################################################
# Check the quota is related to the whole project, so even new apps will not be
# able to spawn anything
###############################################################################
rasca@anomalia [~/MMUL/Avaloq]> oc new-app --name=nginx-test-double --docker-image=nginx
--> Found Docker image 7042885 (6 days old) from Docker Hub for "nginx"

    * An image stream will be created as "nginx-test-double:latest" that will track this image
    * This image will be deployed in deployment config "nginx-test-double"
    * Port 80/tcp will be load balanced by service "nginx-test-double"
      * Other containers can access this service through the hostname "nginx-test-double"
    * WARNING: Image "nginx" runs as the 'root' user which may not be permitted by your cluster administrator

--> Creating resources ...
    imagestream "nginx-test-double" created
    deploymentconfig "nginx-test-double" created
    service "nginx-test-double" created
--> Success
    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:
     'oc expose svc/nginx-test-double' 
    Run 'oc status' to view your app.
rasca@anomalia [~/MMUL/Avaloq]> oc status
In project test-resources on server https://192.168.42.251:8443

svc/nginx-test - 172.30.3.95:80
  dc/nginx-test deploys istag/nginx-test:latest 
    deployment #1 deployed 6 minutes ago - 6/7 pods growing to 7

svc/nginx-test-double - 172.30.23.154:80
  dc/nginx-test-double deploys istag/nginx-test-double:latest 
    deployment #1 new 2 seconds ago


4 infos identified, use 'oc status -v' to see details.

###############################################################################
# Here's a way to monitor the events while they are happening
###############################################################################
rasca@anomalia [~/MMUL/Avaloq]> watch "oc get events --sort-by=".lastTimestamp" | tail -10"
